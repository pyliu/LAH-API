<?php
require_once(dirname(dirname(__FILE__))."/include/init.php");

function getExpireCaseData (&$regdata) {
	return array(
		"Êî∂‰ª∂Â≠óËôü" => $regdata->getReceiveSerial(),
		"ÁôªË®òÂéüÂõ†" => $regdata->getCaseReason(),
		"Ëæ¶ÁêÜÊÉÖÂΩ¢" => $regdata->getStatus(),
		"Êî∂‰ª∂ÊôÇÈñì" => $regdata->getReceiveDate()." ".$regdata->getReceiveTime(),
		"ÈôêËæ¶ÊúüÈôê" => $regdata->getDueDate(),
		"ÂàùÂØ©‰∫∫Âì°" => $regdata->getFirstReviewer() . " " . $regdata->getFirstReviewerID(),
		"‰ΩúÊ•≠‰∫∫Âì°" => $regdata->getCurrentOperator()
	);
}

function findMaxScheduledCloseDatetime(&$rows, $st_index) {
	$row = $rows[$st_index];
	$max = $row['RM29_1'].$row['RM29_2'];
	$rm32 = intval($row['RM32']);
	for ($i = 1; $i < $rm32; $i++) {
		// init val
		$st_rm01 = $row['RM01'];
		$st_rm02 = $row['RM02'];
		$st_rm03 = $row['RM03'];
		$st_rm03_val = intval($row['RM03']);
		// move to next row
		$row = $rows[$st_index + $i];

		$now_rm03_val = intval($row['RM03']);
		$offset = $now_rm03_val - $st_rm03_val;
		if ($st_rm01 !== $row['RM01'] || $st_rm02 !== $row['RM02'] || $offset > 10 || $offset < 0) {
			Logger::getInstance()->warning("ÁõÆÂâçÔºö$st_rm01-$st_rm02-$st_rm03 <==> ‰∏ã‰∏ÄÁ≠ÜÔºö".$row['RM01']."-".$row['RM02']."-".$row['RM03']);
			return false;
		}

		$current = $row['RM29_1'].$row['RM29_2'];
		if ($current > $max) {
			$max = $current;
			Logger::getInstance()->info("ÊúÄÂ§ßÈ†êË®àÁµêÊ°àÊó•ÊúüÊôÇÈñìË®≠ÂÆöÁÇ∫ ".$row['RM01']."-".$row['RM02']."-".$row['RM03']." Ê°à‰ª∂Ë≥áÊñô üëâ $max");
		}
	}
	return $max;
}

$prefetch = new Prefetch();
switch ($_POST["type"]) {
	case "overdue_reg_cases_filtered":
		Logger::getInstance()->info("XHR [overdue_reg_cases_filtered] ÈÄæÊúüÊ°à‰ª∂Êü•Ë©¢Ë´ãÊ±Ç");
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadOverdueCaseIn15Days() : $prefetch->getOverdueCaseIn15Days();
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [overdue_reg_cases_filtered] Êü•ÁÑ°ÈÄæÊúüË≥áÊñô");
			echoJSONResponse("Êü•ÁÑ°ÈÄæÊúüË≥áÊñô", STATUS_CODE::SUCCESS_WITH_NO_RECORD, array(
				"items" => array(),
				"items_by_id" => array(),
				"data_count" => 0,
				"raw" => $rows,
				'cache_remaining_time' => $prefetch->getOverdueCaseCacheRemainingTime()
			));
		} else {
			$items = [];
			$items_by_id = [];

			$tw_date = new Datetime("now");
			$tw_date->modify("-1911 year");
			$now = ltrim($tw_date->format("YmdHis"), "0");	// ex: 1120725084812

			$date_15days_before = new Datetime("now");
			$date_15days_before->modify("-1911 year");
			$date_15days_before->modify("-15 days");
			$start = ltrim($date_15days_before->format("YmdHis"), "0");	// ex: 1120710084812
			
			$count = count($rows);
			for ($i = 0; $i < $count; $i++) {
				$row = $rows[$i];
				$scheduled_close_datetime = $row['RM29_1'].$row['RM29_2'];
				$case_count = intval($row['RM32']);
				if ($case_count < 2) {
					if ($now >= $scheduled_close_datetime) {
						$regdata = new RegCaseData($row);
						$this_item = getExpireCaseData($regdata);
						$items[] = $this_item;
						$items_by_id[$regdata->getFirstReviewerID()][] = $this_item;
					}
				} else {
					// find max scheduled close datetime
					$max_scheduled_close_datetime = findMaxScheduledCloseDatetime($rows, $i);
					if ($max_scheduled_close_datetime === false) {
						// the series cases not valid ... skip this case
						Logger::getInstance()->warning($row['RM01']."-".$row['RM02']."-".$row['RM03']." ÈÄ£‰ª∂Ë≥áÊñôÂà§Êñ∑ÊúâË™§ÔºåÁï∂‰ΩúÂñÆÁç®Ê°à‰ª∂ËôïÁêÜ„ÄÇ");
						if ($now >= $scheduled_close_datetime) {
							$regdata = new RegCaseData($row);
							$this_item = getExpireCaseData($regdata);
							$items[] = $this_item;
							$items_by_id[$regdata->getFirstReviewerID()][] = $this_item;
						}
						continue;
					}
					// all or nothing
					if ($now >= $max_scheduled_close_datetime) {
						for ($y = 0; $y < $case_count; $y++) {
							$tmp = $rows[$i + $y];
							$regdata = new RegCaseData($tmp);
							$this_item = getExpireCaseData($regdata);
							$items[] = $this_item;
							$items_by_id[$regdata->getFirstReviewerID()][] = $this_item;
						}
					}
					// skip series cases to next start pivot
					$i += ($case_count - 1);
				}
			}

			Logger::getInstance()->info("XHR [overdue_reg_cases_filtered] ÊâæÂà∞".count($items)."‰ª∂ÈÄæÊúüÊ°à‰ª∂");
			echoJSONResponse("ÊâæÂà∞".count($items)."‰ª∂ÈÄæÊúüÊ°à‰ª∂", STATUS_CODE::SUCCESS_NORMAL, array(
				"items" => $items,
				"items_by_id" => $items_by_id,
				"data_count" => count($items),
				"raw" => $rows,
				'cache_remaining_time' => $prefetch->getNotCloseCaseCacheRemainingTime()
			));
		}
		break;
	case "overdue_reg_cases":
		Logger::getInstance()->info("XHR [overdue_reg_cases] Ëøë15Â§©ÈÄæÊúüÊ°à‰ª∂Êü•Ë©¢Ë´ãÊ±Ç");
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadOverdueCaseIn15Days() : $prefetch->getOverdueCaseIn15Days();
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [overdue_reg_cases] Ëøë15Â§©Êü•ÁÑ°ÈÄæÊúüË≥áÊñô");
			echoJSONResponse("15Â§©ÂÖßÊü•ÁÑ°ÈÄæÊúüË≥áÊñô", STATUS_CODE::SUCCESS_WITH_NO_RECORD, array(
				"items" => array(),
				"items_by_id" => array(),
				"data_count" => 0,
				"raw" => $rows,
				'cache_remaining_time' => $prefetch->getOverdueCaseCacheRemainingTime()
			));
		} else {
			$items = [];
			$items_by_id = [];
			foreach ($rows as $row) {
				$regdata = new RegCaseData($row);
				$this_item = getExpireCaseData($regdata);
				$items[] = $this_item;
				$items_by_id[$regdata->getFirstReviewerID()][] = $this_item;
			}
			Logger::getInstance()->info("XHR [overdue_reg_cases] Ëøë15Â§©ÊâæÂà∞".count($items)."‰ª∂ÈÄæÊúüÊ°à‰ª∂");
			echoJSONResponse("Ëøë15Â§©ÊâæÂà∞".count($items)."‰ª∂ÈÄæÊúüÊ°à‰ª∂", STATUS_CODE::SUCCESS_NORMAL, array(
				"items" => $items,
				"items_by_id" => $items_by_id,
				"data_count" => count($items),
				"raw" => $rows,
				'cache_remaining_time' => $prefetch->getOverdueCaseCacheRemainingTime()
			));
		}
		break;
	case "almost_overdue_reg_cases":
		Logger::getInstance()->info("XHR [almost_overdue_reg_cases] Âç≥Â∞áÈÄæÊúüÊ°à‰ª∂Êü•Ë©¢Ë´ãÊ±Ç");
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadAlmostOverdueCase() : $prefetch->getAlmostOverdueCase();
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [almost_overdue_reg_cases] Ëøë4Â∞èÊôÇÂÖßÊü•ÁÑ°Âç≥Â∞áÈÄæÊúüË≥áÊñô");
			echoJSONResponse("Ëøë4Â∞èÊôÇÂÖßÊü•ÁÑ°Âç≥Â∞áÈÄæÊúüË≥áÊñô", STATUS_CODE::SUCCESS_WITH_NO_RECORD, array(
				"items" => array(),
				"items_by_id" => array(),
				"data_count" => 0,
				"raw" => $rows,
				'cache_remaining_time' => $prefetch->getAlmostOverdueCaseCacheRemainingTime()
			));
		} else {
			$items = [];
			$items_by_id = [];
			foreach ($rows as $row) {
				$regdata = new RegCaseData($row);
				$this_item = getExpireCaseData($regdata);
				$items[] = $this_item;
				$items_by_id[$regdata->getFirstReviewerID()][] = $this_item;
			}
			Logger::getInstance()->info("XHR [almost_overdue_reg_cases] Ëøë4Â∞èÊôÇÂÖßÊâæÂà∞".count($items)."‰ª∂Âç≥Â∞áÈÄæÊúüÊ°à‰ª∂");
			echoJSONResponse("Ëøë4Â∞èÊôÇÂÖßÊâæÂà∞".count($items)."‰ª∂Âç≥Â∞áÈÄæÊúüÊ°à‰ª∂", STATUS_CODE::SUCCESS_NORMAL, array(
				"items" => $items,
				"items_by_id" => $items_by_id,
				"data_count" => count($items),
				"raw" => $rows,
				'cache_remaining_time' => $prefetch->getAlmostOverdueCaseCacheRemainingTime()
			));
		}
		break;
	case "reg_rm30_H_case":
		Logger::getInstance()->info("XHR [reg_rm30_H_case] Êü•Ë©¢ÁôªË®òÂÖ¨Âëä‰∏≠Ê°à‰ª∂Ë´ãÊ±Ç");
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadRM30HCase() : $prefetch->getRM30HCase();
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [reg_rm30_H_case] Êü•ÁÑ°Ë≥áÊñô");
			echoJSONResponse('Êü•ÁÑ°ÂÖ¨Âëä‰∏≠Ê°à‰ª∂');
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [reg_rm30_H_case] Êü•Ë©¢ÊàêÂäü($total)");
			$baked = array();
			foreach ($rows as $row) {
				$data = new RegCaseData($row);
				$baked[] = $data->getBakedData();
			}
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠ÜÂÖ¨Âëä‰∏≠Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				'data_count' => $total,
				'baked' => $baked,
				'cache_remaining_time' => $prefetch->getRM30HCaseCacheRemainingTime()
			));
		}
		break;
	case "reg_cancel_ask_case":
		Logger::getInstance()->info("XHR [reg_cancel_ask_case] Êü•Ë©¢Ë´ãÁ§∫(ÂèñÊ∂à)Ê°à‰ª∂Ë´ãÊ±Ç");
		$begin = $_POST['begin'];
		$end = $_POST['end'];
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadAskCase($begin, $end) : $prefetch->getAskCase($begin, $end);
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [reg_cancel_ask_case] Êü•ÁÑ°ÊõæÁ∂ìË´ãÁ§∫(ÂèñÊ∂à)Ê°à‰ª∂Ë≥áÊñô");
			echoJSONResponse('Êü•ÁÑ°ÊõæÁ∂ìË´ãÁ§∫(ÂèñÊ∂à)Ê°à‰ª∂');
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [reg_cancel_ask_case] Êü•Ë©¢ÊàêÂäü($total, $begin ~ $end)");
			$baked = array();
			foreach ($rows as $row) {
				$data = new RegCaseData($row);
				$baked[] = $data->getBakedData();
			}
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠ÜÊõæÁ∂ìË´ãÁ§∫(ÂèñÊ∂à)Ê°à‰ª∂Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"baked" => $baked,
				'cache_remaining_time' => $prefetch->getAskCaseCacheRemainingTime($begin, $end)
			));
		}
		break;
	case "reg_trust_case":
		Logger::getInstance()->info("XHR [reg_trust_case] Êü•Ë©¢Ë´ãÁ§∫(ÂèñÊ∂à)Ê°à‰ª∂Ë´ãÊ±Ç");
		if ($_POST['query'] === 'E') {
			// Âª∫Áâ©ÊâÄÊúâÊ¨äÈÉ®Ë≥áÊñô
			$rows = $_POST['reload'] === 'true' ? $prefetch->reloadTrustRebow($_POST['year']) : $prefetch->getTrustRebow($_POST['year']);
			$cache_remaining = $prefetch->getTrustRebowCacheRemainingTime($_POST['year']);
		} else if ($_POST['query'] === 'B') {
			// ÂúüÂú∞ÊâÄÊúâÊ¨äÈÉ®Ë≥áÊñô
			$rows = $_POST['reload'] === 'true' ? $prefetch->reloadTrustRblow($_POST['year']) : $prefetch->getTrustRblow($_POST['year']);
			$cache_remaining = $prefetch->getTrustRblowCacheRemainingTime($_POST['year']);
		} else if ($_POST['query'] === 'TE') {
			// Âª∫Áâ©ÊâÄÊúâÊ¨äÈÉ®‰æãÂ§ñË≥áÊñô
			$rows = $_POST['reload'] === 'true' ? $prefetch->reloadTrustRebowException($_POST['year']) : $prefetch->getTrustRebowException($_POST['year']);
			$cache_remaining = $prefetch->getTrustRebowExceptionCacheRemainingTime($_POST['year']);
		} else if ($_POST['query'] === 'TB') {
			// ÂúüÂú∞ÊâÄÊúâÊ¨äÈÉ®‰æãÂ§ñË≥áÊñô
			$rows = $_POST['reload'] === 'true' ? $prefetch->reloadTrustRblowException($_POST['year']) : $prefetch->getTrustRblowException($_POST['year']);
			$cache_remaining = $prefetch->getTrustRblowExceptionCacheRemainingTime($_POST['year']);
		}
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [reg_trust_case] Êü•ÁÑ°Ë≥áÊñô");
			echoJSONResponse('Êü•ÁÑ°‰ø°Ë®óË®ªË®òË≥áÊñô');
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [reg_trust_case] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü‰ø°Ë®óË®ªË®òË≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $rows,
				'cache_remaining_time' => $cache_remaining
			));
		}
		break;
	case "reg_non_scrivener_case":
		Logger::getInstance()->info("XHR [reg_non_scrivener_case] Êü•Ë©¢ÈùûÂ∞à‰ª£Ê°à‰ª∂Ë´ãÊ±Ç");
		$st = $_POST['start_date'];
		$ed = $_POST['end_date'];
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadNonScrivenerCase($st, $ed) : $prefetch->getNonScrivenerCase($st, $ed);
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [reg_non_scrivener_case] Êü•ÁÑ°Ë≥áÊñô");
			echoJSONResponse('Êü•ÁÑ°ÈùûÂ∞à‰ª£Ê°à‰ª∂');
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [reg_non_scrivener_case] Êü•Ë©¢ÊàêÂäü($total)");
			$baked = array();
			foreach ($rows as $row) {
				$data = new RegCaseData($row);
				$baked[] = $data->getBakedData();
			}
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠ÜÈùûÂ∞à‰ª£Ê°à‰ª∂„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"baked" => $baked,
				'cache_remaining_time' => $prefetch->getNonScrivenerCaseCacheRemainingTime($st, $ed)
			));
		}
		break;
	case "reg_non_scrivener_reg_case":
		Logger::getInstance()->info("XHR [reg_non_scrivener_reg_case] Êü•Ë©¢ÈùûÂ∞à‰ª£Ê°à‰ª∂Ë´ãÊ±Ç");
		$st = $_POST['start_date'];
		$ed = $_POST['end_date'];
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadNonScrivenerRegCase($st, $ed, $_POST['ignore']) : $prefetch->getNonScrivenerRegCase($st, $ed, $_POST['ignore']);
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [reg_non_scrivener_reg_case] Êü•ÁÑ°Ë≥áÊñô");
			echoJSONResponse('Êü•ÁÑ°ÈùûÂ∞à‰ª£Ê°à‰ª∂');
		} else {
			$total = count($rows);
			$baked = array();
			foreach ($rows as $row) {
				$data = new RegCaseData($row);
				$baked[] = $data->getBakedData();
			}
			Logger::getInstance()->info("XHR [reg_non_scrivener_reg_case] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠ÜÈùûÂ∞à‰ª£Ê°à‰ª∂„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"baked" => $baked,
				'cache_remaining_time' => $prefetch->getNonScrivenerRegCaseCacheRemainingTime($st, $ed, $_POST['ignore'])
			));
		}
		break;
	case "reg_non_scrivener_sur_case":
		Logger::getInstance()->info("XHR [reg_non_scrivener_sur_case] Êü•Ë©¢ÈùûÂ∞à‰ª£Ê∏¨ÈáèÊ°à‰ª∂Ë´ãÊ±Ç");
		$st = $_POST['start_date'];
		$ed = $_POST['end_date'];
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadNonScrivenerSurCase($st, $ed, $_POST['ignore']) : $prefetch->getNonScrivenerSurCase($st, $ed, $_POST['ignore']);
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [reg_non_scrivener_sur_case] Êü•ÁÑ°Ë≥áÊñô");
			echoJSONResponse('Êü•ÁÑ°ÈùûÂ∞à‰ª£Ê∏¨ÈáèÊ°à‰ª∂');
		} else {
			$total = count($rows);
			$baked = array();
			foreach ($rows as $row) {
				$data = new SurCaseData($row);
				$baked[] = $data->getBakedData();
			}
			Logger::getInstance()->info("XHR [reg_non_scrivener_sur_case] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠ÜÈùûÂ∞à‰ª£Ê∏¨ÈáèÊ°à‰ª∂„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"baked" => $baked,
				'cache_remaining_time' => $prefetch->getNonScrivenerSurCaseCacheRemainingTime($st, $ed, $_POST['ignore'])
			));
		}
		break;
	case "reg_foreigner_case":
		Logger::getInstance()->info("XHR [reg_foreigner_case] Êü•Ë©¢Â§ñÂúã‰∫∫Âú∞Ê¨äÊ°à‰ª∂Ë´ãÊ±Ç");
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadForeignerCase($_POST['begin'], $_POST['end']) : $prefetch->getForeignerCase($_POST['begin'], $_POST['end']);
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [reg_foreigner_case] Êü•ÁÑ°Ë≥áÊñô");
			echoJSONResponse('Êü•ÁÑ°Â§ñÂúã‰∫∫Âú∞Ê¨äÊ°à‰ª∂');
		} else {
			$total = count($rows);
			$baked = array();
			foreach ($rows as $row) {
				$data = new RegCaseData($row);
				$baked[] = $data->getBakedData();
			}
			Logger::getInstance()->info("XHR [reg_foreigner_case] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠ÜÂ§ñÂúã‰∫∫Âú∞Ê¨äÊ°à‰ª∂„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"baked" => $baked,
				'cache_remaining_time' => $prefetch->getForeignerCaseCacheRemainingTime($_POST['begin'], $_POST['end'])
			));
		}
		break;
	case "trust_query":
		Logger::getInstance()->info("XHR [trust_query] Êü•Ë©¢‰ø°Ë®óÁõ∏ÈóúË≥áÊñôË´ãÊ±Ç");
		$type_msg = "‰ø°Ë®óÁõ∏ÈóúË≥áÊñô";
		if ($_POST['query'] === 'land') {
			// ÂúüÂú∞Ë®ªË®òÂ°óÈä∑
			$type_msg = "ÂúüÂú∞Ë®ªË®òÂ°óÈä∑Êü•Ë©¢";
			$rows = $_POST['reload'] === 'true' ? $prefetch->reloadTrustObliterateLand($_POST['start'], $_POST['end']) : $prefetch->getTrustObliterateLand($_POST['start'], $_POST['end']);
			$cache_remaining = $prefetch->getTrustObliterateLandCacheRemainingTime($_POST['start'], $_POST['end']);
		} else if ($_POST['query'] === 'building') {
			// Âª∫Áâ©Ë®ªË®òÂ°óÈä∑
			$type_msg = "Âª∫Áâ©Ë®ªË®òÂ°óÈä∑Êü•Ë©¢";
			$rows = $_POST['reload'] === 'true' ? $prefetch->reloadTrustObliterateBuilding($_POST['start'], $_POST['end']) : $prefetch->getTrustObliterateBuilding($_POST['start'], $_POST['end']);
			$cache_remaining = $prefetch->getTrustObliterateBuildingCacheRemainingTime($_POST['start'], $_POST['end']);
		} else if ($_POST['query'] === 'reg_reason') {
			// ‰ø°Ë®óÊ°à‰ª∂Ë≥áÊñôÊü•Ë©¢
			$type_msg = "‰ø°Ë®óÊ°à‰ª∂Ë≥áÊñôÊü•Ë©¢";
			$rows = $_POST['reload'] === 'true' ? $prefetch->reloadTrustQuery($_POST['start'], $_POST['end']) : $prefetch->getTrustRegQuery($_POST['start'], $_POST['end']);
			$cache_remaining = $prefetch->getTrustRegQueryCacheRemainingTime($_POST['start'], $_POST['end']);
			foreach ($rows as $idx => $row) {
				$regdata = new RegCaseData($row);
				$rows[$idx] = $regdata->getBakedData();
			}
		}
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [trust_query] Êü•ÁÑ°${type_msg}Ë≥áÊñô");
			echoJSONResponse('Êü•ÁÑ°‰ø°Ë®óÁõ∏ÈóúË≥áÊñô');
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [trust_query] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü${type_msg}Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $rows,
				'cache_remaining_time' => $cache_remaining
			));
		}
		break;
	case "375_land_change":
		Logger::getInstance()->info("XHR [375_lang_change] Êü•Ë©¢375ÁßüÁ¥ÑÂúüÊ®ôÈÉ®Áï∞ÂãïË≥áÊñôË´ãÊ±Ç");
		$message = "375ÁßüÁ¥ÑÂúüÂú∞Ê®ôÁ§∫ÈÉ®Áï∞ÂãïÊü•Ë©¢";
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadLand375Change($_POST['start'], $_POST['end']) : $prefetch->getLand375Change($_POST['start'], $_POST['end']);
		$cache_remaining = $prefetch->getLand375ChangeCacheRemainingTime($_POST['start'], $_POST['end']);
		foreach ($rows as $idx => $row) {
			$regdata = new RegCaseData($row);
			$rows[$idx] = $regdata->getBakedData();
		}
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [375_lang_change] Êü•ÁÑ° ${message} Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° ${message} Ë≥áÊñô");
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [375_lang_change] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü ${message} Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $rows,
				'cache_remaining_time' => $cache_remaining
			));
		}
		break;
	case "375_owner_change":
		Logger::getInstance()->info("XHR [375_owner_change] Êü•Ë©¢375ÁßüÁ¥ÑÂúüÊâÄÈÉ®Áï∞ÂãïË≥áÊñôË´ãÊ±Ç");
		$message = "375ÁßüÁ¥ÑÂúüÂú∞ÊâÄÊúâÊ¨äÈÉ®Áï∞ÂãïÊü•Ë©¢";
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadOwner375Change($_POST['start'], $_POST['end']) : $prefetch->getOwner375Change($_POST['start'], $_POST['end']);
		$cache_remaining = $prefetch->getOwner375ChangeCacheRemainingTime($_POST['start'], $_POST['end']);
		foreach ($rows as $idx => $row) {
			$regdata = new RegCaseData($row);
			$rows[$idx] = $regdata->getBakedData();
		}
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [375_owner_change] Êü•ÁÑ° ${message} Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° ${message} Ë≥áÊñô");
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [375_owner_change] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü ${message} Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $rows,
				'cache_remaining_time' => $cache_remaining
			));
		}
		break;
	case "not_done_change":
		Logger::getInstance()->info("XHR [not_done_change] Êü•Ë©¢Êú™Ëæ¶Ê®ôÁöÑË®ªË®òÁï∞ÂãïË≥áÊñôË´ãÊ±Ç");
		$message = "Êú™Ëæ¶Ê®ôÁöÑË®ªË®òÁï∞ÂãïÊü•Ë©¢";
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadNotDoneChange($_POST['start'], $_POST['end']) : $prefetch->getNotDoneChange($_POST['start'], $_POST['end']);
		$cache_remaining = $prefetch->getNotDoneChangeCacheRemainingTime($_POST['start'], $_POST['end']);
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [not_done_change] Êü•ÁÑ° ${message} Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° ${message} Ë≥áÊñô");
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [not_done_change] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü ${message} Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $rows,
				'cache_remaining_time' => $cache_remaining
			));
		}
		break;
	case "land_ref_change":
		Logger::getInstance()->info("XHR [land_ref_change] Êü•Ë©¢ÂúüÂú∞ÂèÉËÄÉË≥áË®äÁï∞ÂãïË≥áÊñôË´ãÊ±Ç");
		$message = "ÂúüÂú∞ÂèÉËÄÉË≥áË®äÁï∞ÂãïÊü•Ë©¢";
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadLandRefChange($_POST['start'], $_POST['end']) : $prefetch->getLandRefChange($_POST['start'], $_POST['end']);
		$cache_remaining = $prefetch->getLandRefChangeCacheRemainingTime($_POST['start'], $_POST['end']);
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [land_ref_change] Êü•ÁÑ° ${message} Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° ${message} Ë≥áÊñô");
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [land_ref_change] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü ${message} Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $rows,
				'cache_remaining_time' => $cache_remaining
			));
		}
		break;
	case "reg_fix_case":
		Logger::getInstance()->info("XHR [reg_fix_case] Êü•Ë©¢Ë£úÊ≠£Ê°à‰ª∂Êü•Ë©¢Ë´ãÊ±Ç");
		$message = "Ë£úÊ≠£Ê°à‰ª∂Êü•Ë©¢";
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadRegFixCase() : $prefetch->getRegFixCase();
		$cache_remaining = $prefetch->getRegFixCaseCacheRemainingTime();
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [reg_fix_case] Êü•ÁÑ° ${message} Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° ${message} Ë≥áÊñô");
		} else {
			require_once(INC_DIR.DIRECTORY_SEPARATOR.'SQLiteRegFixCaseStore.class.php');
			$sqlite_db = new SQLiteRegFixCaseStore();

			$total = count($rows);
			$baked = array();
			foreach ($rows as $row) {
				$data = new RegCaseData($row);
				$this_baked = $data->getBakedData();

				
				$id = $this_baked['ID'];
				// this query goes to SQLite DB
				$result = $sqlite_db->getRegFixCaseRecord($id);
				$this_baked['REG_FIX_CASE_RECORD'] = $result[0] ?? [];

				$baked[] = $this_baked;
			}
			Logger::getInstance()->info("XHR [reg_fix_case] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü ${message} Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $baked,
				'cache_remaining_time' => $cache_remaining
			));
		}
		break;
	case "reg_not_done_case":
		Logger::getInstance()->info("XHR [reg_not_done_case] Êü•Ë©¢Êú™ÁµêÊ°àÁôªË®òÊ°à‰ª∂Ë´ãÊ±Ç");
		$message = "Êú™ÁµêÊ°àÁôªË®òÊ°à‰ª∂Êü•Ë©¢";
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadRegNotDoneCase() : $prefetch->getRegNotDoneCase();
		$cache_remaining = $prefetch->getRegNotDoneCaseCacheRemainingTime();
		
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [reg_not_done_case] Êü•ÁÑ° ${message} Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° ${message} Ë≥áÊñô");
		} else {
			// also get authority from sqlite db
			require_once(INC_DIR.DIRECTORY_SEPARATOR.'SQLiteRegAuthChecksStore.class.php');
			$sqlite_db = new SQLiteRegAuthChecksStore();

			$total = count($rows);
			$baked = array();
			foreach ($rows as $row) {
				$data = new RegCaseData($row);
				$this_baked = $data->getBakedData();

				$id = $this_baked['ID'];
				// this query goes to SQLite DB, return array of result
				$result = $sqlite_db->getRegAuthChecksRecord($id);
				$this_baked['CASE_NOTIFY_RAW'] = $result;
				if (is_array($result) && count($result) === 1) {
					$auth = $result[0];
					$this_baked['CASE_NOTIFY_AUTHORITY'] = $auth['authority'];
					$this_baked['CASE_NOTIFY_NOTE'] = $auth['note'];
				} else{
					// default is 0 that means the case don't need to notify applicant
					$this_baked['CASE_NOTIFY_AUTHORITY'] = 0;
					$this_baked['CASE_NOTIFY_NOTE'] = '';
				}

				$baked[] = $this_baked;
			}
			Logger::getInstance()->info("XHR [reg_not_done_case] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü ${message} Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $baked,
				'cache_remaining_time' => $cache_remaining
			));
		}

		break;
	case "reg_untaken_case":
		Logger::getInstance()->info("XHR [reg_untaken_case] Êü•Ë©¢ÁµêÊ°àÊú™Ê≠∏Ê™îÁôªË®òÊ°à‰ª∂Ë´ãÊ±Ç");
		$message = "ÁµêÊ°àÊú™Ê≠∏Ê™îÁôªË®òÊ°à‰ª∂Êü•Ë©¢";
		$st = $_POST['start'];
		$ed = $_POST['end'];
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadRegUntakenCase($st, $ed) : $prefetch->getRegUntakenCase($st, $ed);
		$cache_remaining = $prefetch->getRegUntakenCaseCacheRemainingTime($st, $ed);
		
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [reg_untaken_case] Êü•ÁÑ° ${message} Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° ${message} Ë≥áÊñô($st ~ $ed)");
		} else {
			// also get authority from sqlite db
			require_once(INC_DIR.DIRECTORY_SEPARATOR.'SQLiteRegUntakenStore.class.php');
			$sqlite_db = new SQLiteRegUntakenStore();

			$total = count($rows);
			$baked = array();
			foreach ($rows as $row) {
				$data = new RegCaseData($row);
				$this_baked = $data->getBakedData();

				$id = $this_baked['ID'];
				// this query goes to SQLite DB, return array of result
				$result = $sqlite_db->getRegUntakenRecord($id);
				$record = $result[0] ?? [];
				$this_baked['UNTAKEN_TAKEN_DATE'] = $record['taken_date'] ?? '';
				$this_baked['UNTAKEN_TAKEN_STATUS'] = $record['taken_status'] ?? '';
				$this_baked['UNTAKEN_LENT_DATE'] = $record['lent_date'] ?? '';
				$this_baked['UNTAKEN_RETURN_DATE'] = $record['return_date'] ?? '';
				$this_baked['UNTAKEN_BORROWER'] = $record['borrower'] ?? '';
				$this_baked['UNTAKEN_NOTE'] = $record['note'] ?? '';

				$baked[] = $this_baked;
			}
			Logger::getInstance()->info("XHR [reg_untaken_case] Êü•Ë©¢ÊàêÂäü($total, $st ~ $ed)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü ${message} Ë≥áÊñô„ÄÇ($st ~ $ed)", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $baked,
				'cache_remaining_time' => $cache_remaining
			));
		}

		break;
	case "sur_overdue_case":
		Logger::getInstance()->info("XHR [sur_overdue_case] Êü•Ë©¢Ê∏¨ÈáèÈÄæÊúüÊ°à‰ª∂Ë´ãÊ±Ç");
		$message = "ÈÄæÊúüÊ∏¨ÈáèÊ°à‰ª∂";
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadSurOverdueCase() : $prefetch->getSurOverdueCase();
		$cache_remaining = $prefetch->getSurOverdueCaseCacheRemainingTime();
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [sur_overdue_case] Êü•ÁÑ° ${message} Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° ${message} Ë≥áÊñô");
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [sur_overdue_case] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü ${message} Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $rows,
				'cache_remaining_time' => $cache_remaining
			));
		}

		break;
	case "sur_not_close_case":
		Logger::getInstance()->info("XHR [sur_not_close_case] Êü•Ë©¢Êú™ÁµêÊ°àÊ∏¨ÈáèÊ°à‰ª∂Ë´ãÊ±Ç");
		$message = "Êú™ÁµêÊ°àÊ∏¨ÈáèÊ°à‰ª∂";
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadSurNotCloseCase() : $prefetch->getSurNotCloseCase();
		$cache_remaining = $prefetch->getSurNotCloseCaseCacheRemainingTime();
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [sur_not_close_case] Êü•ÁÑ° ${message} Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° ${message} Ë≥áÊñô");
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [sur_not_close_case] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü ${message} Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $rows,
				'cache_remaining_time' => $cache_remaining
			));
		}

		break;
	case "sur_near_case":
		Logger::getInstance()->info("XHR [sur_near_case] Êü•Ë©¢Âç≥Â∞áÂà∞ÊúüÊ∏¨ÈáèÊ°à‰ª∂Ë´ãÊ±Ç");
		$message = "Âç≥Â∞áÂà∞ÊúüÊ∏¨ÈáèÊ°à‰ª∂";
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadSurNearCase() : $prefetch->getSurNearCase();
		$cache_remaining = $prefetch->getSurNearCaseCacheRemainingTime();
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [sur_near_case] Êü•ÁÑ° ${message} Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° ${message} Ë≥áÊñô");
		} else {
			$total = count($rows);
			Logger::getInstance()->info("XHR [sur_near_case] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü ${message} Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				"data_count" => $total,
				"raw" => $rows,
				'cache_remaining_time' => $cache_remaining
			));
		}

		break;
	case "val_realprice_map":
		Logger::getInstance()->info("XHR [val_realprice_map] Êü•Ë©¢ÂØ¶ÂÉπÁôªÈåÑÁî≥Â†±Â∞çÊáâË´ãÊ±Ç");
		$message = "ÂØ¶ÂÉπÁôªÈåÑÁî≥Â†±Ê°à‰ª∂";
		$st = $_POST["start_date"];
		$ed = $_POST["end_date"];
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadValRealPriceMap($st, $ed) : $prefetch->getValRealPriceMap($st, $ed);
		$cache_remaining = $prefetch->getValRealPriceMapCacheRemainingTime($st, $ed);
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [val_realprice_map] Êü•ÁÑ° ${message} Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° ${message} Ë≥áÊñô");
		} else {
			$total = count($rows);
			$baked = array();

			require_once(INC_DIR.DIRECTORY_SEPARATOR.'SQLiteValRealpriceMemoStore.class.php');
			$sqlite_db = new SQLiteValRealpriceMemoStore();

			foreach ($rows as $row) {
				$data = new RegCaseData($row);
				$this_baked = $data->getBakedData();

				$caseNo = $this_baked['P1MP_CASENO'] ?? $this_baked['ID'];
				if (!empty($caseNo)) {
					// this query goes to SQLite DB, return array of result
					$result = $sqlite_db->getValRealpriceMemoRecord($caseNo);
					// fallback to use reg case id as key to find memo data
					if (empty($result)) {
						$result = $sqlite_db->getValRealpriceMemoRecord($this_baked['ID']);
					}
					$this_baked['P1MP_DECLARE_RAW'] = $result;
					if (is_array($result) && count($result) === 1) {
						$memo = $result[0];
						$this_baked['P1MP_DECLARE_DATE'] = $memo['declare_date'];
						$this_baked['P1MP_DECLARE_NOTE'] = $memo['declare_note'];
					} else{
						// default is 1 that means the case needs to notify applicant
						$this_baked['P1MP_DECLARE_DATE'] = '';
						$this_baked['P1MP_DECLARE_NOTE'] = '';
					}
				}
				$baked[] = $this_baked;
			}
			Logger::getInstance()->info("XHR [val_realprice_map] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü ${message} Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				// "data_count" => $total,
				// "raw" => $rows,
				// 'cache_remaining_time' => $cache_remaining,
				"data_count" => $total,
				"baked" => $baked,
				'cache_remaining_time' => $cache_remaining
			));
		}
		break;
	case "reg_inheritance_restriction":
		Logger::getInstance()->info("XHR [reg_inheritance_restriction] Êü•Ë©¢Â§ñ‰∫∫ÁÆ°Âà∂Ê∏ÖÂÜäË≥áÊñôË´ãÊ±Ç");
		$message = "Â§ñ‰∫∫ÁÆ°Âà∂Ê∏ÖÂÜä";
		$rows = $_POST['reload'] === 'true' ? $prefetch->reloadRegInheritanceRestriction() : $prefetch->getRegInheritanceRestriction();
		$cache_remaining = $prefetch->getRegInheritanceRestrictionCacheRemainingTime();
		if (empty($rows)) {
			Logger::getInstance()->info("XHR [reg_inheritance_restriction] Êü•ÁÑ° $message Ë≥áÊñô");
			echoJSONResponse("Êü•ÁÑ° $message Ë≥áÊñô");
		} else {
			$total = count($rows);
			$srfr = new SQLiteRegForeignerRestriction();
			$baked = array();
			// to check if PDF exists
			$srfp = new SQLiteRegForeignerPDF();
			foreach ($rows as $row) {
				$data = new RegCaseData($row);
				$this_baked = $data->getBakedData();
				// use pkey(Âú∞ÊÆµ+Âú∞Ëôü+Áµ±Á∑®) to read restriction data
				$pkey = $row['BA48'].$row['BA49'].$row['BB09'].$row['BB07'];
				$this_baked['RESTRICTION_DATA'] = $srfr->getOne($pkey);
				$this_baked['hasPDF'] = $srfp->exists($row['BB03'], $row['BB04_2'], $row['BB09']) > 0;
				$baked[] = $this_baked;
			}
			Logger::getInstance()->info("XHR [reg_inheritance_restriction] Êü•Ë©¢ÊàêÂäü($total)");
			echoJSONResponse("Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞ $total Á≠Ü $message Ë≥áÊñô„ÄÇ", STATUS_CODE::SUCCESS_WITH_MULTIPLE_RECORDS, array(
				// "data_count" => $total,
				// "raw" => $rows,
				// 'cache_remaining_time' => $cache_remaining,
				"data_count" => $total,
				"baked" => $baked,
				'cache_remaining_time' => $cache_remaining
			));
		}
		break;
	default:
		Logger::getInstance()->error("‰∏çÊîØÊè¥ÁöÑÊü•Ë©¢ÂûãÊÖã„Äê".$_POST["type"]."„Äë");
		echoJSONResponse("‰∏çÊîØÊè¥ÁöÑÊü•Ë©¢ÂûãÊÖã„Äê".$_POST["type"]."„Äë", STATUS_CODE::UNSUPPORT_FAIL);
		break;
}
