<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="For zhongli land office use only">
<meta name="author" content="LIU, PANG-YU">
<title>桃園市中壢地政事務所</title>

<!-- Bootstrap core CSS -->
<link rel="stylesheet" href="assets/css/bootstrap.min.css">
<link rel="stylesheet" href="assets/css/loading.css">
<link rel="stylesheet" href="assets/css/loading-btn.css">
<link href="assets/css/animate.css" rel="stylesheet">
<link href="assets/css/awesome-font.css" rel="stylesheet">
<!-- Custom styles for this template -->
<link href="assets/css/bootstrap-vue.min.css" rel="stylesheet">
<link href="assets/css/main.css" rel="stylesheet">
</head>

<body>
  <section>
    <div class="container-fluid" v-cloak>
        <div id="tracking"></div>
    </div>
  </section><!-- /section -->
  <!-- Bootstrap core JavaScript -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/popper.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <!-- Vue -->
  <script src="assets/js/vue.js"></script>
  <script src="assets/js/vuex.js"></script>
  <script src="assets/js/bootstrap-vue.min.js"></script>
  <script src="assets/js/bootstrap-vue-icons.min.js"></script>
  <!-- Add-On -->
  <script src="assets/js/axios.min.js"></script>
  <script src="assets/js/localforage.min.js"></script>
  <script src="assets/js/global.js"></script>
  <script src="assets/js/Chart.min.js"></script>
  <script src="assets/js/vue-countdown.min.js"></script>
  <script src="assets/js/components/lah-global.js"></script>
  <script src="assets/js/components/lah-components.js"></script>


  <script type="text/javascript">
    $(document).ready(e => {
        window.trackingApp = new Vue({
            components: { "countdown": VueCountdown },
            el: "#tracking",
            template: `<div>
                <div style="right: 2.5rem; position:absolute; top: 90px;">
                    <b-button size="sm" variant="light" @click="$('.b-table tbody tr').removeClass('hide')" class="border px-3"><lah-fa-icon icon="list"></lah-fa-icon> 全部</b-button>
                    <b-button size="sm" variant="success" @click="$('.b-table tbody tr').addClass('hide'); $('.b-table tbody tr.filter-success').removeClass('hide');"><lah-fa-icon icon="suitcase"></lah-fa-icon> 已結案</b-button>
                    <b-button size="sm" variant="warning" @click="$('.b-table tbody tr').addClass('hide'); $('.b-table tbody tr.filter-warning').removeClass('hide');"><lah-fa-icon prefix="far" icon="clock"></lah-fa-icon> 快逾期</b-button>
                    <b-button size="sm" variant="danger" @click="$('.b-table tbody tr').addClass('hide'); $('.b-table tbody tr.filter-danger').removeClass('hide');"><lah-fa-icon icon="stopwatch"></lah-fa-icon> 已逾期</b-button>
                    <b-button id="reload" variant="primary" size="sm" @click="reload">
                        <lah-fa-icon icon="sync-alt"> 刷新</lah-fa-icon>
                        <b-badge variant="light">
                            <countdown ref="countdown" :time="milliseconds" @end="handleCountdownEnd" @start="handleCountdownStart" :auto-start="false">
                                <template slot-scope="props">{{ props.minutes.toString().padStart(2, '0') }}:{{ props.seconds.toString().padStart(2, '0') }}</template>
                            </countdown>
                            <span class="sr-only">倒數</span>
                        </b-badge>
                    </b-button>
                </div>
                <lah-reg-table
                    :baked-data="reg_cases_by_day"
                    :max-height="reg_cases_by_day_max_height"
                    :color="false"
                    icon="chevron-circle-right"
                    iconVariant="primary"
                    class="s-90"
                    type="xl"
                ></lah-reg-table>
            </div>`,
            data: {
                reg_cases_by_day: undefined,
                reg_cases_by_day_max_height: window.innerHeight - 130,
                milliseconds: 60 * 5 * 1000, // cached for 5 mins
                overdue: false,
                almost: false,
                
            },
            methods: {
                async reload(force = false) {
                    if (force) await this.removeLocalCache('reg_cases_by_day');
                    let d = new Date();
                    let today = `${d.getFullYear() - 1911}${("0" + (d.getMonth()+1)).slice(-2)}${("0" + d.getDate()).slice(-2)}`;
                    let cached = await this.getLocalCache('reg_cases_by_day');
                    if (cached !== false) {
                        this.reg_cases_by_day = cached;
                        let remaining_ms = await this.getLocalCacheExpireRemainingTime('reg_cases_by_day');
                        this.setCountdown(remaining_ms);
                        this.startCountdown();
                    } else {
                        this.isBusy = true;
                        this.endCountdown();
                        this.$http.post(CONFIG.JSON_API_EP, {
                            type: "reg_cases_by_day",
                            qday: today
                        }).then(res => {
                            if (res.data.status == XHR_STATUS_CODE.SUCCESS_NORMAL) {
                                this.reg_cases_by_day = res.data.baked;
                                this.setLocalCache('reg_cases_by_day', res.data.baked, this.milliseconds);   
                                this.resetCountdown();
                            } else {
                                addNotification({
                                    title: "查詢今日案件",
                                    message: res.data.message,
                                    type: "warning"
                                });
                            }
                        }).catch(err => {
                            this.error = err;
                        }).finally(() => {
                            this.isBusy = false;
                            this.startCountdown();
                        });
                    }
                },
                handleCountdownEnd() { this.reload(true) },
                handleCountdownStart() {},    
                resetCountdown: function () {
                    this.$refs.countdown.totalMilliseconds = this.milliseconds;
                },
                setCountdown: function (milliseconds) {
                    this.$refs.countdown.totalMilliseconds = milliseconds || this.milliseconds;
                },
                startCountdown: function () {
                    this.$refs.countdown.start();
                },
                endCountdown: function () {
                    this.$refs.countdown.end();
                },
            },
            created() {
                //this.busyIconSize="lg";
                this.reload();
            }
        });
    });
  </script>
</body>
</html>
